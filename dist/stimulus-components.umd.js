!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@hotwired/stimulus"),require("@rails/activestorage"),require("sortablejs"),require("uuid")):"function"==typeof define&&define.amd?define(["exports","@hotwired/stimulus","@rails/activestorage","sortablejs","uuid"],t):t((e||self).stimulusComponents={},e.Stimulus,e.activestorage,e.sortablejs,e.uuid)}(this,function(e,t,i,r,n){function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/a(r);function s(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,c(e,t)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}var d=/*#__PURE__*/function(){function e(e,t){var r=this;this.handleChange=function(e){r.options.onChangeFile(e)},this.handleProgress=function(e){r.handleChange({state:"uploading",file:r.directUpload.file,id:r.options.id,progress:e.loaded/e.total*100})},this.handleSuccess=function(e){return r.handleChange({state:"finished",id:r.options.id,file:r.directUpload.file,signedId:e}),e},this.handleError=function(e){throw r.handleChange({state:"error",id:r.options.id,file:r.directUpload.file,error:e}),e},this.directUpload=new i.DirectUpload(e,"/rails/active_storage/direct_uploads",this),this.options=t}var t=e.prototype;return t.start=function(){var e=this;return new Promise(function(t,i){e.directUpload.create(function(e,r){e?i(e):t(r.signed_id)})}).then(this.handleSuccess).catch(this.handleError)},t.directUploadWillCreateBlobWithXHR=function(e){this.options.onBeforeBlobRequest&&this.options.onBeforeBlobRequest({id:this.options.id,file:this.directUpload.file,xhr:e})},t.directUploadWillStoreFileWithXHR=function(e){this.options.onBeforeStorageRequest&&this.options.onBeforeStorageRequest({id:this.options.id,file:this.directUpload.file,xhr:e}),e.upload.addEventListener("progress",this.handleProgress)},e}(),h=/*#__PURE__*/function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).handleFileProgress=function(e){var i=document.querySelector('[data-temp-id="'+e.id+'"]');switch(e.state){case"uploading":i.querySelector(".progress-bar").style.width=e.progress+"%";break;case"error":i.remove(),setMessage("alert","Error uploading "+e.file.name+".");break;case"finished":i.querySelector(".upload-progress").remove();var r=document.createElement("input");r.setAttribute("type","hidden"),r.setAttribute("value",e.signedId),r.name=i.querySelector("input[name*='_destroy']").name.replace(/_destroy/g,"file"),i.appendChild(r),t.updateCount()}},t}u(t,e);var i=t.prototype;return i.handleFileClick=function(){if(this.hasMaxFilesValue&&this.activeFiles.length>=this.maxFilesValue)return setMessage("alert","Maximum files allowed: "+this.maxValue),!1;this.inputTarget.click()},i.handleNewFiles=function(e){try{var t=this,i=Array.from(e.target.files);return t.hasMaxFilesValue&&i.length+t.activeFiles.length>t.maxFilesValue?(setMessage("alert","Maximum files allowed: "+t.maxValue),Promise.resolve(!1)):Promise.resolve(Promise.all(i.map(function(e){return t.approveFile(e)}))).then(function(e){var i=e.filter(Boolean).map(function(e){return e});t.submitFiles(i),t.inputTarget.value=null})}catch(e){return Promise.reject(e)}},i.approveFile=function(e){try{var t,i=this;if(i.hasWhitelistValue&&!i.whitelistValue.includes(e.type))return setMessage("alert","Invalid file type: "+e.name),Promise.resolve(!1);if(i.hasmaxMbValue&&e.size>i.maxMb)return setMessage("alert","File size too large: "+e.name),Promise.resolve(!1);var r=function(){if(i.hasMaxDimensionValue)return Promise.resolve(i.getLargestDimension(e)).then(function(r){if(r>i.MaxDimensionValue)return setMessage("alert","Dimensions are too lage: "+e.name),t=1,!1})}();return Promise.resolve(r&&r.then?r.then(function(i){return t?i:e}):t?r:e)}catch(e){return Promise.reject(e)}},i.getLargestDimension=function(e){return new Promise(function(t){var i=new Image;i.src=URL.createObjectURL(e),i.onload=function(){var e=Math.max(i.width,i.height);URL.revokeObjectURL(i.src),t(e)}})},i.createAttachment=function(e){return this.element.nestedForm.addAssociation(e)},i.removeAttachment=function(e){this.element.nestedForm.removeAssociation(e),this.updateCount()},i.submitFiles=function(e){var t=this;e.forEach(function(e){var i=t.createAttachment();i.insertAdjacentHTML("beforeend",'\n        <div class="upload-progress">\n          <div class="progress-bar"></div>\n        </div>\n      '),i.querySelector(".filename").innerText=e.name,e.type.includes("image")&&i.querySelector("img")&&(i.querySelector("img").src=URL.createObjectURL(e)),new d(e,{id:i.dataset.tempId,onChangeFile:t.handleFileProgress}).start()})},i.updateCount=function(){this.hasCountTarget&&(this.countTarget.value=this.activeFiles.length)},i.setMessage=function(e,t){console.log(t)},l(t,[{key:"activeFiles",get:function(){return this.fileTargets.filter(function(e){return!e.classList.contains("destroying")})}}]),t}(t.Controller);h.targets=["input","file","count","message"],h.values={maxFiles:Number,minFiles:Number,maxMb:Number,maxDimension:Number,whitelist:Array};var f=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;return i.initialize=function(){this.element.nestedForm=this},i.findTemplate=function(e){return e?this.templateTargets.find(function(t){return t.dataset.templateName==e}):this.templateTarget},i.addAssociation=function(e){if(this.hasMaxValue&&this.activeItems.length>=this.maxValue)return setMessage("alert","Maximum allowed: "+this.maxValue),!1;var t=void 0===e?this.templateTarget:this.findTemplate(e.target.value),i=Date.now()*Math.floor(100*Math.random()),r=t.innerHTML.replace(new RegExp(this.replaceKeyValue,"g"),i);this.listTarget.insertAdjacentHTML("beforeend",r);var n=this.listTarget.lastElementChild;return n.dataset.tempId=i,this.listTarget.sortableController&&this.listTarget.sortableController.update(),n},i.removeAssociation=function(e){if(this.confirmRemoveValue&&!1===confirm("Are you sure?"))return!1;var t=e.target.closest("[data-nested-form-target='item']");"true"==t.dataset.newRecord?t.remove():(t.querySelector("input[name*='_destroy']").value=1,t.classList.add("hidden","destroying"))},i.setMessage=function(e,t){console.log(t)},l(t,[{key:"activeItems",get:function(){return this.itemTargets.filter(function(e){return!e.classList.contains("destroying")})}}]),t}(t.Controller);f.targets=["list","item","template","message"],f.values={replaceKey:{type:String,default:"NEW_RECORD"},max:Number,min:Number,confirmRemove:Boolean};var m=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;return i.initialize=function(){this.element.sortableController=this,this.sortable=o.default.create(this.element,{group:n.v4(),animation:150,onEnd:this.end.bind(this),filter:"input, button, select, textarea",preventOnFilter:!1})},i.update=function(){this.positionTargets.forEach(function(e,t){return e.value=t})},i.end=function(){this.update()},t}(t.Controller);m.targets=["position"],e.ActivestorageAttachments=h,e.NestedForm=f,e.Sortable=m});
//# sourceMappingURL=stimulus-components.umd.js.map
